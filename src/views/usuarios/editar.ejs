<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="/usuarios">Usuarios</a></li>
        <li class="breadcrumb-item active">Editar</li>
      </ol>
    </nav>
    <h2 class="mb-0"><i class="bi bi-pencil me-2"></i>Editar Usuario</h2>
  </div>
  <a href="/usuarios" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Volver
  </a>
</div>

<% if (typeof error !== 'undefined' && error) { %>
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="bi bi-exclamation-triangle me-2"></i><%= error %>
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %>

<form action="/usuarios/<%= usuario.ID_Usuario %>" method="POST">
  <div class="row g-4">
    <!-- Información de la cuenta -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-badge me-2"></i>Información de la Cuenta
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="Nombre_Completo" required
                   value="<%= usuario.Nombre_Completo %>"
                   placeholder="Ej: Juan Pérez García">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Correo Electrónico <span class="text-danger">*</span></label>
            <input type="email" class="form-control" name="Email_Office365" required
                   value="<%= usuario.Email_Office365 %>"
                   placeholder="correo@empresa.com">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Nueva Contraseña</label>
            <div class="input-group">
              <input type="password" class="form-control" name="Password" id="password"
                     minlength="6" placeholder="Dejar vacío para mantener la actual">
              <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()">
                <i class="bi bi-eye" id="toggleIcon"></i>
              </button>
            </div>
            <div class="form-text">Solo completar si deseas cambiar la contraseña</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label text-muted">Información adicional</label>
            <table class="table table-sm table-borderless mb-0">
              <tr>
                <td class="text-muted">Creado:</td>
                <td><%= new Date(usuario.CreatedAt).toLocaleString('es-MX') %></td>
              </tr>
              <tr>
                <td class="text-muted">Último acceso:</td>
                <td>
                  <% if (usuario.Ultimo_Acceso) { %>
                    <%= new Date(usuario.Ultimo_Acceso).toLocaleString('es-MX') %>
                  <% } else { %>
                    <span class="text-muted">Nunca</span>
                  <% } %>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rol y Permisos -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-shield-lock me-2"></i>Rol y Permisos
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Rol del Usuario <span class="text-danger">*</span></label>
            <select class="form-select" name="ID_Rol" required>
              <option value="">Seleccionar rol...</option>
              <% if (typeof roles !== 'undefined' && roles) { %>
                <% roles.forEach(function(rol) { %>
                  <option value="<%= rol.ID_Rol %>" <%= usuario.ID_Rol === rol.ID_Rol ? 'selected' : '' %>>
                    <%= rol.Nombre_Rol %>
                    <% if (rol.Descripcion) { %> - <%= rol.Descripcion %><% } %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Vincular a Empleado</label>
            <select class="form-select" name="ID_Empleado">
              <option value="">Sin vincular</option>
              <% if (typeof empleados !== 'undefined' && empleados) { %>
                <% empleados.forEach(function(emp) { %>
                  <option value="<%= emp.ID_Empleado %>" <%= usuario.ID_Empleado === emp.ID_Empleado ? 'selected' : '' %>>
                    <%= emp.Nombre %> <%= emp.Apellido_Paterno %> <%= emp.Apellido_Materno || '' %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="Activo" id="activo" 
                     <%= usuario.Activo ? 'checked' : '' %>>
              <label class="form-check-label" for="activo">
                Usuario Activo
              </label>
            </div>
            <div class="form-text">Los usuarios inactivos no pueden iniciar sesión</div>
          </div>
        </div>
      </div>
      
      <!-- Zona de peligro -->
      <div class="card border-danger mt-4">
        <div class="card-header bg-danger text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>Zona de Peligro
          </h5>
        </div>
        <div class="card-body">
          <p class="mb-3">Eliminar este usuario permanentemente. Esta acción no se puede deshacer.</p>
          <form action="/usuarios/<%= usuario.ID_Usuario %>/eliminar" method="POST" class="d-inline"
                onsubmit="return confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')">
            <button type="submit" class="btn btn-outline-danger">
              <i class="bi bi-trash me-1"></i> Eliminar Usuario
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Botones -->
    <div class="col-12">
      <div class="d-flex justify-content-end gap-2">
        <a href="/usuarios" class="btn btn-outline-secondary">
          <i class="bi bi-x-lg me-1"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-lg me-1"></i> Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</form>

<script>
function togglePassword() {
  const password = document.getElementById('password');
  const icon = document.getElementById('toggleIcon');
  
  if (password.type === 'password') {
    password.type = 'text';
    icon.classList.remove('bi-eye');
    icon.classList.add('bi-eye-slash');
  } else {
    password.type = 'password';
    icon.classList.remove('bi-eye-slash');
    icon.classList.add('bi-eye');
  }
}
</script>
